---
title: "Space for WHAM: a multi-region, multi-stock generalization of the Woods Hole Assessment Model with an application to black sea bass"
author: 
  - Timothy J. Miller^1^^,2^
  - Kiersten L. Curti^1^^,3^
  - Alexander C. Hansell^1^^,4^
# date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::pdf_document2:
    keep_tex: yes
    toc: no
    number_sections: yes
    fig_caption: yes
    includes:
      in_header: options_main_final.sty
csl: canadian-journal-of-fisheries-and-aquatic-sciences.csl
bibliography: bsb-wham.bib
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy=FALSE, tidy.opts=list(width.cutoff=60), warning = FALSE, message = FALSE, fig.align = "center")
#knitr::opts_knit$set(root.dir = '../')
library(knitr)
library(tidyverse)
library(pander)
library(kableExtra)
#library(wham)
#library(ggplotFL)
#library(viridis)
type <- "latex"
if(knitr::is_latex_output()) type <- "latex"
if(knitr::is_html_output()) type <- "html"
```
$1$ Northeast Fisheries Science Center, National Marine Fisheries Service, 166 Water Street, Woods Hole, MA 02543, USA\
$2$ orcid: 0000-0003-1411-1206, timothy.j.miller@noaa.gov\
$3$ orcid: 0009-0009-1676-7269\
$4$ orcid: 0000-0001-7827-1749\

\pagebreak

**keywords:** stock assessment, state-space, multi-stock, multi-region, age-structured, black sea bass


## Abstract {-}

The Woods Hole Assessment Model is a general state-space age-structured assessment model that is used to assess and manage many stocks in the Northeast US. We first describe an extension of the model allowing any number of stocks (or stock components) and regions with movement among regions as well as seasonal variation in stock and fleet dynamics. Movement rates can be functions of time- and age-varying random effects and environmental covariates. We then illustrate the model by applying it to data for the northern and southern components of the Northeast United States black sea bass stock and evaluate alternative hypotheses of bottom temperature and time-varying random effects on recruitment and natural mortality. We show strong evidence for temperature effects on recruitment, primarily for the northern stock component, and no evidence for including random effects or temperature effects on age 1 natural mortality.

\pagebreak

# Introduction {-}

State-space age-structured stock assessment models can be used to estimate time and age-varying population attributes as random effects using maximum marginal likelihood or Bayesian fitting procedures [@nielsenberg14;@cadigan16;@milleretal16]. This estimation approach is considered an essential feature of gold-standard assessment models that we use in tactical management of commercially important fish stocks [@puntetal20]. The State-space Assessment Model [SAM, @nielsenberg14] continues to be developed and remains widely used within  the International Council for the Exploration of the Sea (ICES) to assess European fish stocks. Various state-space models are being used to manage cod and plaice stocks in the waters of Eastern Canada [@varkeyetal22;@perreaultetal20] and to the south, the Woods Hole Assessment Model [WHAM, @stockmiller21] is now used to assess many fish stocks in the Northwest Atlantic Ocean [@nefsc22;@nefsc22a;@nefsc24].

WHAM is an R package developed and maintained by scientists at NOAA's Northeast Fisheries Science Center (https://timjmiller.github.io/wham). WHAM can be configured to fit a wide range of age-structured models from traditional statistical catch-at-age models without any random effects, to models with several time and age varying process errors and effects of environmental covariates on various population parameters. Like SAM, WHAM models are built using the Template Model Builder package [TMB, @kristensenetal16] which provides a computationally efficient means of fitting an extremely wide class of models with random effects. WHAM has undergone active development since its creation and includes random effects options for recruitment, inter-annual transitions of numbers at age (hereafter referred to as "apparent survival"), fishery and index selectivity, natural mortality, and catchability. 

However, WHAM has only allowed consideration of a single stock and region, and no seasonal changes in stock dynamics. Using such models for stocks that have subcomponents with varying seasonal movement can provide incorrect inferences and poor management advice [@bosleyetal22;@yingetal11;@caoetal14]. Furthermore, the ability to account for spatial structure and model multiple stocks are also important features of leading-edge assessment modeling frameworks [@puntetal20]. We describe here the implementation of these features and other extensions since @stockmiller21 in WHAM version 2.0. Many of these new configuration options can also be useful when modeling a single stock and region.

We developed this extension of WHAM in concert with a research track assessment process for black sea bass [BSB\, \textit{Centropristis striata}\; @nefsc23], which is a high profile stock in the Northeast U.S. and important to both commercial fishing fleets and recreational anglers. BSB are targeted from Maine to North Carolina in both state and federal waters. Past stock assessments have estimated that the stock is healthy (not overfished and overfishing not occurring). Those assessments assumed two stock components (north and south), each assessed with a separate statistical catch at age model, with results subsequently combined to inform management. However, the assessments exhibited strong retrospective patterns. The stock was split into two regional components to account for spatial dynamics and improve model diagnostics [@asmfc16]. Additionally, BSB have complex spatial dynamics and make seasonal migrations, moving inshore in the spring and offshore in the fall [@mosershepherd09]. BSB distribution has been linked to warming waters on the northwest shelf [@belletal15] and it is hypothesized that the distribution and productivity of the BSB stock is especially susceptible to long-term changes in temperature causing increases in abundance further north [@hareetal16]. Thus, a focus of the BSB research track assessment was to develop an assessment platform that could capture multiple stock components, complex seasonal movement, and explore environmental drivers of population dynamics [@nefsc23]. We denote the fish in the north as separate stock components rather than stocks because both components are managed as a single stock, but recognizing differences in migration between fish originating in the two areas. 

To illustrate the usage of WHAM 2.0 we apply it to the two stock components of BSB off the coast of the Northeast United States (NEUS) using most of the model assumptions that were accepted during the peer-review process [@nefsc23]. However, here we evaluate evidence for alternative hypotheses of temporal variation and effects of bottom temperature, specifically, on recruitment and natural mortality of age 1 individuals. 

When modeling multiple stock components and regions, further dimensionality is added to the class of possible equilbrium reference points [e.g., @kapuretal21]. Short term projections are also an important part of the management process and the separation of observation and process errors in state-space models allows uncertainty in projected attributes such as recruitment and spawning stock biomass (SSB) without external simulation exercises.  Finally, the inclusion of explicit effects of environmental covariates in the model also requires assumptions on how they are treated in projections and reference points. We demonstrate some of the options of WHAM version 2.0 to provide biological reference points and short-term projections.

# Methods {-}

## WHAM description {-}

Many of the options and equations of WHAM version 2.0 are the same as those in @stockmiller21, so we will only describe extensions and differences that have occurred since their first description of WHAM. The new version of WHAM can model multiple stocks, each with their own movement, harvest, and natural mortality. Much of the description below is for a specific stock $s$, but, for simplicity, this subscript is implicit except when necessary. We have provided an Appendix A Table \ref{symbols} containing definitions of all mathematical notation in this paper.

### The probability transition matrix {-}

Because individuals may be alive in one of several regions or harvested by one of several fleets, it is helpful to consider these as distinct categories or states and treat the number of individuals occurring in each category over time as a multi-state model. Approaches to modeling transitions among these states may treat time discretely [e.g.,@arnason72;@schwarzetal93] or continuously [e.g., @hearnetal87;@commenges99; @andersenkeiding02]. We can define a probability transition matrix (PTM) that describes the probability of individuals occurring in different states at the end of a time interval with duration $\delta$ (columns), conditional on being in each of those states at the beginning of the interval (rows). For fish populations, these states would be defined as being alive in a particular region or deceased due to fishing from a particular fleet or natural mortality. The time interval $i$ with duration $\delta_i$ would be a season and the PTMs would be uniquely defined for each stock by year $y$, age $a$, and season $i$. Each row and column of the PTM correspond to one of the states: alive in region $r$, dead in fleet $f$, or dead from natural causes. The probabilities in each row sum to one (must be in one of the states) and assume an individual is in the state that corresponds to that row at the beginning of the interval. Given $n_R$ regions and $n_F$ fleets, the square PTM ($n_R + n_F + 1$ rows and columns) as a function of sub-matrices is
\begin{equation}\label{eq:ptm}
  \mathbf{P}_{y,a,i} = \begin{bmatrix}
    \mathbf{O}_{y,a,i} & \mathbf{H}_{y,a,i} & \mathbf{D}_{y,a,i} \\
    0 & \mathbf{I}_{H} & 0\\
    0 & 0 & 1
  \end{bmatrix},
\end{equation}
where 
\begin{equation*}
  \mathbf{O}_{y,a,i} = 
  \begin{bmatrix}
    O_{y,a,i}(1,1) & \cdots & O_{y,a,i}(1,n_R) \\
    \vdots & \ddots & \vdots \\
    O_{y,a,i}(n_R,1) & \cdots & O_{y,a,i}(n_R,n_R)
  \end{bmatrix}
\end{equation*}
is the $n_R \times n_R$ matrix defining survival and occurring in each region at the end of the interval,
\begin{equation*} 
  \mathbf{H}_{y,a,i} = 
  \begin{bmatrix}
    H_{y,a,i}(1,1) & \cdots & H_{y,a,i}(1,n_F) \\
    \vdots & \ddots & \vdots \\
    H_{y,a,i}(n_R,1) & \cdots & H_{y,a,i}(n_R,n_F)
  \end{bmatrix}
\end{equation*}
is the $n_R \times n_F$ matrix defining probabilities of being captured in each fleet during the interval, and $\mathbf{D}_{y,a,i}$ is the $n_R \times 1$ matrix of probabilities of dying due to natural mortality during the interval. We have the $n_F\times n_F$ identity matrix $\mathbf{I}_{H}$ for the states of capture by each fleet and a 1 for the natural mortality state because the probabilities of being in one of the mortality states given starting the interval in that state is one (no zombies allowed). 

WHAM uses these PTMs to model abundance proportions in each state rather than true probabilities where numbers in each state would have a multinomial distribution as in a model for tagging data where fates of individual tagged fish are assumed independent. The PTMs determine the expected numbers 1) in each state on January 1 of year $y+1$ at age $a+1$ given the abundances at age $a$ on January 1 of year $y$, 2) captured over the year in each fleet, 3) available to each index, and 4) alive at the time and in the region where spawning occurs. 

### Single region PTMs {-}

When there is only one region,
\begin{equation}\label{eq:ptm_1_region}
\mathbf{P}_{y,a,i} = 
  \begin{bmatrix}
     S_{y,a,i} & \mathbf{H}_{y,a,i} & D_{y,a,i} \\
     0 & \mathbf{I}_{H} & 0\\
     0 & 0 & 1
  \end{bmatrix},
\end{equation}
where $S_{y,a,i} = e^{-Z_{y,a,i}\delta_i}$, $\mathbf{H}_{y,a,i}$ is a 1 x $n_F$ matrix with elements for each fleet $f$: $\frac{F_{f,y,a,i}}{Z_{y,a,i}}\left(1 - e^{-Z_{y,a,i}\delta_i}\right)$, $D_{y,a,i} = \frac{M_{y,a}}{Z_{y,a,i}}\left(1 - e^{-Z_{y,a,i}\delta_i}\right)$, and $Z_{y,a,i} = M_{y,a} + \sum^{n_F}_{f=1} F_{f,y,a,i}$ is the total mortality rate.


### Multi-region PTMs {-}

When there is more than one region, WHAM can model survival and movement as processes occurring sequentially or simultaneously. The sequential assumption is used widely in spatially explicit models [e.g., Stock Synthesis, @methotwetzel13]. Under the sequential assumption, survival and death occur over the interval and movement among regions occurs instantly at either the beginning or the end of the interval. WHAM is configured to have movement occur after survival:
\begin{equation*}
  \mathbf{O}_{y,a,i} = \mathbf{S}_{y,a,i}\boldsymbol{\mu}_{y,a,i},
\end{equation*}
where $\mathbf{S}_{y,a,i}$ is a $n_R \times n_R$ diagonal matrix of proportions surviving in each region (given they start in that region) 
\begin{equation*}
\mathbf{S}_{y,a,i} = 
  \begin{bmatrix}
    e^{-Z_{y,a,i,1}\delta_i} & 0 & \cdots & 0 \\
    0 & e^{-Z_{y,a,i,2}\delta_i} & \cdots & 0 \\
    \vdots & \vdots & \ddots & \vdots \\
    0 & \cdots & 0 & e^{-Z_{y,a,i,n_R}\delta_i}
  \end{bmatrix}
\end{equation*}
and $\boldsymbol{\mu}_{y,a,i}$ is a $n_R \times n_R$ matrix of proportions moving from one region to another or staying in the region they occurred at the beginning of the interval: 
\begin{equation*}
\boldsymbol{\mu}_{y,a,i} = 
  \begin{bmatrix}
    1-\sum_{r' \neq 1} \mu_{1\rightarrow r',y,a,i} & \mu_{1\rightarrow 2,y,a,i} & \cdots & \mu_{1\rightarrow R,y,a,i} \\
    \mu_{2\rightarrow 1,y,a,i} & 1-\sum_{r' \neq 2} \mu_{2\rightarrow r',y,a,i} & \cdots & \mu_{2\rightarrow R,y,a,i} \\
    \vdots & \vdots & \ddots & \vdots \\
    \mu_{R\rightarrow 1,y,a,i} & \cdots & \mu_{R\rightarrow R-1,y,a,i} & 1-\sum_{r' \neq R} \mu_{R\rightarrow r',y,a,i}
  \end{bmatrix}
\end{equation*}

WHAM assumes each fleet $f$ can harvest in only one region ($r_f$) during specified seasons. So, for each fleet $f$, row $r_f$ and column $f$ of $\mathbf{H}_{y,a,i}$ will be $F_{f,y,a,i}\left(1 - e^{-Z_{y,a,i,r}\delta_i}\right)/Z_{y,a,i,r}$ when fleet $f$ is harvesting during the interval $i$ and all other elements will be zero. Row $r$ of the single-column matrix $\mathbf{D}_{y,a,i}$ is  $M_{y,a,r}\left(1 - e^{-Z_{y,a,i,r}\delta_i}\right)/Z_{y,a,i,r}$. For details defining PTMs with movement and mortality occurring simultaneously see Appendix B.

### Seasonality {-}

Seasonality can be configured to accommodate characteristics of spawning, movement, and fleet-specific behavior. The annual time step can be divided into $K$ seasons and the interval duration $\delta_i$ for each season $i$ does not need to be equal to any other seasonal interval. Under the Markov assumption the PTMs for each consecutive interval are independent and the PTM of surviving, moving, and dying over $K$ intervals $1,\ldots, K$ (i.e., the entire year) is just the product of the PTMs for each interval:
$$ \mathbf{P}_{y,a}(\delta_1,\ldots,\delta_K) = \prod^K_{i=1}\mathbf{P}_{y,a,i}(\delta_i).$$

For a stock spawning at some fraction of the year $0<t_s<1$ in interval $i \in \{1,\ldots,K\}$, the fraction of time in the interval is 
$$\delta_{s,i} = t_s-\sum^{i-1}_{j=0}\delta_j$$
(where $\delta_0 = 0$), and the PTM defining the proportions in each state at time $t_s$ for age $a$ is
\begin{equation}\label{eq:ptm_spawn}
\mathbf{P}_{y,a}\left(\delta_1,\ldots,\delta_{i-1}, \delta_{s,i}\right) = \mathbf{P}_{y,a}\left(t_s\right) =  \left[\prod^{i-1}_{j=0}\mathbf{P}_{y,a,j}(\delta_j)\right]\mathbf{P}_{y,a,i}(\delta_{s,i}),
\end{equation}
where $\mathbf{P}_{y,a,0}$ is an identity matrix. Similarly, for an index $m$ occurring  at fraction of the year $t_m$ in interval $i$ the proportions in each state at the time of the observation is
\begin{equation} \label{eq:ptm_index} 
\mathbf{P}_{y,a}\left(\delta_1,\ldots,\delta_{i-1}, \delta_{m,i}\right) = \mathbf{P}_{y,a}\left(t_m\right) =   \left[\prod^{i-1}_{j=0}\mathbf{P}_{y,a,i}(\delta_j)\right]\mathbf{P}_{y,a,i}(\delta_{m,i}).
\end{equation}

### Numbers at age {-}

When there are $n_R$ regions and $n_F$ fleets, the vector of abundance for a given stock (component) in each state at age $a>1$ on January 1 is $\mathbf{N}_{y,a}^T = (\mathbf{N}_{O,y,a}^T, \mathbf{0}^T)$, where $\mathbf{N}_{O,y,a} = (N_{y,a,1}, \ldots, N_{y,a,n_R})^T$ is the number in the states corresponding to being alive in each region and $\mathbf{0}$ is a vector ($n_F+1$) for the numbers captured in each fleet or dead from natural mortality because no age $a$ fish have died yet on January 1. 

Each stock $s$ is assumed to spawn and recruit in one region $r_s$. So for age $a=1$, $\mathbf{N}_{O,y,1}$ is 0 except for row $r_s$. Options for configuring recruitment ($N_{y,1,r_s}$) for each stock are the same as previous versions of WHAM. If recruitment is assumed to be a function of SSB, it is only the spawning population in region $r_s$ at the time of spawning that constitutes the SSB in the stock-recruit function. However, models can configure individuals to occur in other regions at the time of spawning. Aside from treating recruitment as a random walk, the general model for annual recruitment as random effects is
\begin{equation*}
\log\left(N_{y,1,r_s}\right)|\text{SSB}_{y-1} =  f\left(\text{SSB}_{y-1}\right) + \varepsilon_{y,1,r_s},
\end{equation*}
where  
$$\text{SSB}_{y} =  \sum^A_{a=1}  w_{y,a} \text{mat}_{y,a} \mathbf{O}_{y,a,\cdot,r_s}^T(t_s) \mathbf{N}_{O,y,a}$$
and $w_{y,a}$ and $\text{mat}_{y,a}$ are the stock-specific mean weight at age of spawning individuals and maturity at age, respectively, and $\mathbf{O}_{y,a,\cdot,r_s}(t_s)$ are the probabilities of surviving and occurring in region $r_s$ at time $t_s$ given being alive in each region at the start of the year (column $r_s$ of the upper-left submatrix of Eq. \ref{eq:ptm_spawn}).

As in previous versions of WHAM, the apparent survival (and movement) from one year to another after recruitment can be treated deterministically or as functions of random effects. The predicted numbers at age $a$ in year $y$ for a given stock are vector analogs ($\mathbf{N}_{O,y,a}$) of the equations for numbers at age in the standard WHAM model [@stockmiller21]. For ages $a = 2,\ldots, A-1$, where $A$ is the plus group, the expected number alive in each region at the beginning of the following year and next age class age can be obtained from the first $n_R$ elements of the vector
$$\mathbf{P}_{y-1,a-1}^T \mathbf{N}_{y-1,a-1}.$$
The numbers alive in each region can also be modeled more simply using the sub-matrix $\mathbf{O}_{y,a}$. The general model for the vector of abundance at age in year $y$ at age $a$ given the vector in year $y-1$ at age $a-1$ is 
\begin{equation*}
\log\left(\mathbf{N}_{O,y,a}\right)|\mathbf{N}_{O,y-1,a-1} =  \log\left(\mathbf{O}_{y-1,a-1}^T \mathbf{N}_{O,y-1,a-1}\right) + \boldsymbol{\varepsilon}_{y,a}
\end{equation*}
for ages $a = 2,\ldots, A-1$, and for the plus group
\begin{equation*}
\log\left(\mathbf{N}_{O,y,A}\right)|\mathbf{N}_{O,y-1,A-1},\mathbf{N}_{O,y-1,A} = \log\left(\mathbf{O}_{y-1,A-1}^T \mathbf{N}_{O,y-1,A-1} + \mathbf{O}_{y-1,A}^T \mathbf{N}_{O,y-1,A}\right) + \boldsymbol{\varepsilon}_{y,A},
\end{equation*}
where $\boldsymbol{\varepsilon}_{y,a}$ is the vector of region-specific errors for a given stock, which are independent across stocks and regions, but the same correlation structures as previous versions are possible across ages and years for a given stock and region.

When there is autocorrelation with age, WHAM now assumes this applies only to ages $a>1$ by default so that recruitment random effects are independent of those for the apparent survival of older age classes. The general covariance structure for a given stock at ages $a>1$ in region $r$ is a two-dimensional first-order autoregressive (2DAR1) process
\begin{equation*}
  Cov\left(\varepsilon_{y,a,r},\varepsilon_{y',a',r}\right) =   \frac{\rho_{N,\text{age},r}^{|a-a'|}\rho_{N,\text{year},r}^{|y-y'|}\sigma_{N,a,r}\sigma_{N,a',r}}{\left(1 -  \rho_{N,\text{age},r}^2\right)\left(1 - \rho_{N,\text{year},r}^2\right)} 
\end{equation*}
and that for age 1 is just AR1 across years 
\begin{equation*}
  Cov\left(\varepsilon_{y,1},\varepsilon_{y',1}\right) =   \frac{\rho_{N,1,\text{year}}^{|y-y'|}\sigma^2_{N,1}}{1 - \rho_{N,1,\text{year}}^2}.
\end{equation*}
If the annual changes in abundance at age are treated deterministically, then $\boldsymbol{\varepsilon}_{y,a} = \mathbf{0}$.  Since recruitment for a given stock currently only occurs in one region $r_s$ there is only a single vector of time-varying recruitment random effects for each stock.


### Initial numbers at age {-}

Initial numbers at age for each stock and region can be treated as age-specific fixed effects or with an equilibrium assumption as in previous versions of WHAM. For the equilibrium option there are two parameters for each stock: the stock-specific equilibrium fully-selected fishing mortality rate ($\widetilde{F}_1$) and the recruitment in year 1 ($N_{1,1,r_s}$). A stock-specific equilibrium fishing mortality at age by fleet ($\widetilde{F}_{f,1,a}$) is the product of $\widetilde{F}_1$ and the selectivity across fleets in the first year
\begin{equation*}
  \text{sel}_{f,1,a} = \frac{F_{f,1,a}}{\max_a \sum_{f=1}^{n_F} F_{f,1,a}}.
\end{equation*}
We use $\widetilde{F}_{f,1,a}$ to define an equilibrium abundance per recruit by region at age $a$ conditional on recruiting to each region
\begin{equation}\label{eq:npraa}
 \widetilde{\mathbf{O}}_{a} = \left\{
 \begin{array}{ll}
\prod^{a-1}_{j=0}\mathbf{O}_{j}  & 1\leq a<A\\
\left[\prod^{a-1}_{j=0}\mathbf{O}_{j}\right] \left(\mathbf{I} - \mathbf{O}_{A}\right)^{-1} & a = A
 \end{array},
\right.
\end{equation}
where $\mathbf{O}_{j}$ is the equilibrium proportions surviving age $a$ and occurring in each region and $\mathbf{O}_{0} = \mathbf{I}$, the identity matrix. Natural mortality and movement rates in the first year of the model are also used in Eq. \ref{eq:npraa}. For the plus group $a=A$, $\left(\mathbf{I} - \mathbf{O}_{A}\right)^{-1}$ is a ``fundamental matrix'' derived using the matrix version of the  geometric series [@kemenysnell60]. Recall that recruitment for a given stock $s$ only occurs in region $r_s$ so, the equilibrium initial numbers at age $a$ by region are 
$$\mathbf{N}_{O,1,a} = \widetilde{\mathbf{O}}_{a,r_s,\cdot} N_{1,1,r_s},$$
where $\widetilde{\mathbf{O}}_{a,r_s,\cdot}$ is the vector of values in row $r_s$ of $\widetilde{\mathbf{O}}_{a}$. Initial abundance at age can also be estimated as random effects as described in Appendix B.

### Parametizing movement {-}

For each season, there are at most $n_R-1$ parameters determining movement for a given stock among regions given starting the season in region $r$ in either the sequential or simultaneous configurations. Movement parameters are estimated on a transformed scale via a link function $g(\cdot)$. If survival and movement occur simultaneously, the parameters are estimated with a log link function  and if they are separable, an additive logit link function (like a multinomial regression) is used. On the transformed scale, the general model for the movement parameter from region $r$ to $r'$ in season $i$ and year $y$ for individuals of age $a$ is a linear function of an intercept or mean parameter ($\theta_{r\rightarrow r',i}$) and both random and covariate effects:
\begin{equation*}
  g(\mu_{r\rightarrow r',y,a,i}) = \theta_{r\rightarrow r',i} + \varepsilon_{r\rightarrow r',y,a,i} + \sum^{n_E}_{k=1} \beta_{r \rightarrow r',a,i,k} X_{k,y}.
\end{equation*}
The random effects $\varepsilon_{r\rightarrow r',y,a,i}$ are region-to-region- and season-specific, and modeled most generally as 2DAR1 random effects with age and(or) year, where the covariance is
\begin{equation*}
  Cov\left(\varepsilon_{r\rightarrow r',y,a,i},\varepsilon_{r\rightarrow r',y',a',i}\right) =   \frac{\rho_{r\rightarrow r',\text{age},i}^{|a-a'|}\rho_{r\rightarrow r',\text{year},i}^{|y-y'|}\sigma^2_{r\rightarrow r',i}}{\left(1 -  \rho_{r\rightarrow r',\text{age},i}^2\right)\left(1 - \rho_{r\rightarrow r',\text{year},i}^2\right)}.
\end{equation*}
This is similar to how WHAM models variation in survival, natural mortality, and selectivity. Covariate $X_k$ effects ($\beta_{r\rightarrow r',a,i,k}$) can be region-to-region-, age-, and season-specific, and the same orthogonal polynomial options in the previous versions of WHAM for effects on recruitment and natural mortality are available. 

There is currently no likelihood component for tagging data. Therefore, movement parameters would usually either need to be fixed or assumed to have some prior distribution, possibly based on external parameter estimates. WHAM includes prior distributions for the region-to-region- and season-specific (mean) movement parameters and treats them as random effects with the mean defined by the initial value of the fixed effect counterpart and standard deviation
  \begin{equation*}
  \gamma_{r\rightarrow r',i} \sim \text{N}\left(\theta_{r\rightarrow r',i}, \sigma^2_{\gamma,r\rightarrow r',i}\right).
  \end{equation*}
When priors are used, the movement is defined instead as
  \begin{equation*}
  g(\mu_{r\rightarrow r',y,a,i}) = \gamma_{r\rightarrow r',i} + \varepsilon_{r\rightarrow r',y,a,i} + \sum^{n_E}_{k=1} \beta_{r\rightarrow r',a,i,k} X_{k,y}.
  \end{equation*}



### Natural mortality {-}

When treated as constant parameters, natural mortality rates may be stock-, region-, and age-specific, but currently are constant across seasons. When random effects are used, the same 2DAR1 structure with age and year as described by @stockmiller21 can be configured for a given stock and region and any environmental covariate effects can be stock-, region-, and age-specific. We provide details in Appendix B. 

### Catch observations {-}

The log-normal distributional assumption for aggregate catch observations is the same as @stockmiller21, but the predicted catch is now a function of catch from each stock starting the year in each region and any seasonal movement. For a given stock $s$ at age $a$, the vector of numbers captured by each fleet over the year $y$ is
$$\mathbf{N}_{H,s,y,a} = \mathbf{H}_{s,y,a}^T \mathbf{N}_{O,s,y,a}$$
(recall each fleet can harvest in only one region as described above). The vector of numbers caught by each fleet across stocks is 
$$\mathbf{N}_{H,y,a} = \sum^{n_S}_{s=1} \mathbf{N}_{H,s,y,a}$$
and the vector of predicted aggregate catch by each fleet at age $a$ is
$$\widehat{\mathbf{C}}_{y,a} = \text{diag}\left(\mathbf{c}_{y,a}\right) \mathbf{N}_{H,y,a},$$
where $\mathbf{c}_{y,a}$ is the vector of mean individual weight at age $a$ for each fleet and the aggregate catch by fleet is 
$$\widehat{\mathbf{C}}_y = \sum^{A}_{a=1} \widehat{\mathbf{C}}_{y,a}.$$
The log-aggregate catch observations for fleet $f$ are normally distributed
$$ \log C_{f,y} \sim \text{N}\left(\log \widehat {C}_{f,y}, \sigma^2_{f,y}\right),$$

where $\widehat C_{f,y}$ is an element of $\widehat{\mathbf{C}}_y$. The predicted numbers caught for each fleet $f$ (row $f$ of $\mathbf{N}_{H,y,a}$) are used to make predicted age composition observations as described by @stockmiller21. Since then, three additional likelihood options for age composition observations have been added: a logistic-normal with AR(1) correlation structure [@francis14], the alternative Dirichlet-multinomial parameterization described by @thorsonetal17, and the multivariate Tweedie [@thorsonetal23].


### Index observations {-}

An index $m$ can observe any stocks that occur in a single region $r_m$ at fraction of the year $t_m$. The abundance at $t_m$ in region $r_m$ is 
$$N_{m,s,y,a} = \mathbf{O}_{s,y,a,\cdot,r_m}^T(t_m) \mathbf{N}_{O,s,y,a},$$
where $\mathbf{O}_{s,y,a,\cdot,r_m}(t_m)$, column $r_m$ of the upper-left submatrix of Eq. \ref{eq:ptm_index}, is the vector of proportions surviving and occurring in region $r_m$ at time $t_m$ given being alive in each region at the start of the year. The predicted index at age is
$$\widehat{I}_{m,y,a} = q_{m,y} \text{sel}_{m,y,a}w_{m,y,a}\sum^{n_S}_{s = 1}N_{m,s,y,a},$$
where $q_{m,y}$ is the catchability of the index in year $y$, $\text{sel}_{m,y,a}$ is the selectivity, and $w_{m,y,a}$ is the average weight of individuals at age $a$ if the index is quantified in biomass and $w_{m,y,a} = 1$ if the index is quantified in numbers. Predicted age composition observations are functions of $\widehat{I}_{m,y,a}$ as described by @stockmiller21 and the likelihood options are the same as those for catch explained above. We describe options to model temporal variation in catchability in Appendix B.


### Reference points {-}

WHAM calculates annual reference points using biological inputs each year and it also provides the same reference points under prevailing conditions where biological inputs are averaged over a user-defined set of recent years. A single fishing mortality reference point $\widetilde{F}$ is estimated across stocks and regions and the fleet- and age-specific reference point is $\widetilde{F}_{f,a} = \widetilde{F} \text{sel}_{f,a}$. Selectivity is determined across fleets and ages as in the equilibrium assumption for initial abundance at age except here it is a function of fishing mortality at age, possibly averaged over years,
\begin{equation}\label{eq:spr_sel}
  \text{sel}_{f,a} = \frac{\overline{F}_{f,a}}{\max_a \sum^{n_F}_{f=1}{\overline{F}}_{f,a}}.
\end{equation}

The equilibrium spawning stock biomass-per-recruit for a given stock in region $r_s$ is defined as
\begin{equation}\label{eq:ssbpr}
 \upphi(\widetilde{F}) = \sum^{A}_{a=1} \widetilde{\mathbf{O}}_{a,r_s,\cdot} \mathbf{O}_{a,\cdot,r_s}(t_s) w_{a} m_{a},
\end{equation}
where $w_{a}$ and $m_{a}$ are the mean individual weight and proportion mature at age $a$, $\widetilde{\mathbf{O}}_{a,r_s,\cdot}$ is row $r_s$ of $\widetilde{\mathbf{O}}_a$ in Eq. \ref{eq:npraa}, and $\mathbf{O}_{a,\cdot,r_s}(t_s)$ is column $r_s$ of the matrix of proportions surviving and occurring in each region at age $a+t_s$ (the upper-left sub-matrix of eq. \ref{eq:ptm_spawn}). Using these rows and columns is required because of the assumption that spawning and recruitment only occur in region $r_s$. For prevailing conditions, the years to average for $w_a$, $m_a$, and natural mortality and movement rates to parameterize $\mathbf{O}_{a}(t_s)$ and $\widetilde{\mathbf{O}}_{a}$, are defined by the user. 
 

The equilibrium yield-per-recruit as a function of $\widetilde{F}$ for a given stock $s$ is calculated as
\begin{equation}\label{eq:ypr}
 \upnu({\widetilde{F}}) = \sum^{A}_{a=1} \widetilde{\mathbf{O}}_{a,r_s,\cdot} \mathbf{H}_{a} \mathbf{c}_{a},
\end{equation}
where $\mathbf{c}_{a}$ is the vector of mean individual weight at age for each fleet, and $\mathbf{H}_{a}$ is the submatrix of the proportions captured in each fleet over the interval from $a$ to $a+1$, defined in eq. \ref{eq:ptm}. Other than mean individual weight, $\upnu({\widetilde{F}})$ uses all of the same (averaged) inputs as $\upphi({\widetilde{F}})$ in Eq. \ref{eq:ssbpr}.

For reference points based on reductions of $\upphi({\widetilde{F}})$ to $p\%$ of the unfished value, $\upphi(0)$ ($p/100$ is known as the spawning potential ratio; SPR), we use a Newton-Raphson method and iterate for steps $j = 1,\ldots,10$
\begin{equation}\label{eq:newton}
  \log\widetilde{F}^{j} = \log\widetilde{F}^{j-1} - \frac{h\left(\log\widetilde{F}^{j-1}\right)}{h^{(1)}\left(\log\widetilde{F}^{j-1}\right)},
\end{equation}
where $h(\log \widetilde{F})$ is the sum of weighted differences between $\upphi({\widetilde{F}})$ and $p$\% of $\upphi_s\left(0\right)$ across stocks:
\begin{equation}\label{eq:newton-obj}
  h(\log \widetilde{F}) = \sum^{n_s}_{s=1} \lambda_s\left[\upphi_s\left(e^{\log \widetilde{F}}\right) - \frac{p}{100}\upphi_s\left(0\right)\right],
\end{equation}
and $h^{(1)}(\log \widetilde{F})$ is the derivative of $h(\log \widetilde{F})$ with respect to $\log \widetilde{F}$ [analogous to the approach for SPR-based reference points in @millerlegault17]. The weights for each stock ($\lambda_s$) can be specific values supplied by the user or defined to be the proportions of average recruitment for each stock where the years used to average are those the user defines to calculate prevailing equilibrium spawning biomass and yield reference points, which are the product of the defined average recruitment and $\upphi({\widetilde{F}})$ and $\upnu({\widetilde{F}})$, respectively. The Newton-Raphson method is used by WHAM internally to allow uncertainty in all estimated parameters to be propagated into uncertainty estimates for the reference points.

When a Beverton-Holt or Ricker stock-recruit relationship is assumed, we use the derivative (with respect to $\widetilde{F}$) of the weighted sum of stock-specific equilibrium yields (the product of $\upnu({\widetilde{F}})$ and equilibrium recruitment from the stock-recruit relationship) as $h(\log \widetilde{F})$ to find $\widetilde{F}$ which maximizes the weighted total yield across stocks for MSY-based reference points [$F_{\text{MSY}}$, analogous to the approach for MSY-based reference points in @milleretal16].

### Projections {-}

The projection options are generally the same as those for previous versions of WHAM. When there is movement of any stocks, the user has the option to project and use any random effects for time-varying movement or use the average over user specified years, analogous to how natural mortality can be treated in the projection period. The projection of any environmental covariates has been revised to better include error in the estimated latent covariate in any effects on the population in projection years. Users can also specify a catch or fully-selected fishing mortality in each projection year and they can be fleet-specific.


# Application to black sea bass {-}

BSB are a temperate reef fish in the western Atlantic Ocean ranging the entire east coast of the United States.  Fish north of Cape Hatteras, NC, are considered to comprise a single NEUS stock unit, but individual populations exhibit spawning site fidelity [@ablehales97;@fabrizioetal13]. Fish in this NEUS stock perform seasonal migrations out on the continental shelf in the fall and back to their inshore spawning areas during the spring [@musickmercer77]. Analyses of tagging studies have demonstrated that the extent of seasonal migration varies along the coast such that fish from populations off of southern New England and further north move offshore and as far south as the coasts of Virgina and North Carolina, whereas fish in the southern portion of the stock range generally move shorter distances between inshore and offshore areas of similar latitude [@mosershepherd09].

Prior to its 2023 peer-reviewed assessment, the NEUS BSB stock was assessed using the Age-Structured Assessment Program (ASAP) model [@legaultrestrepo99], a single-stock and -region statistical catch-at-age model that estimates all model parameters as fixed effects. Northern and southern components of the NEUS BSB stock ascribed to regions divided by the Hudson Canyon were separately modeled in ASAP (Figure \ref{fig:map}). Results from the separate ASAP models were combined for a unit-stock assessment. The ASAP-based assessments exhibited strong retrospective patterns [@mohn99], and exploring alternative modeling approaches for the northern and southern stock components has been a high priority for management.   

Leading up to the 2023 peer-reviewed assessment, a working group (hereafter referred to as "Working Group") composed of scientists from federal, state, and academic institutions determined an optimal data and model configuration for the BSB stock using the multi-stock and multi-region extension of WHAM described above [@nefsc23]. This assessment included the two regions and two stock components and investigated inclusion of hypothesized environmental drivers that were prioritized research recommendations from previous BSB assessments. Below we describe the assumptions and configuration of the assessment model as determined by the Working Group as well as the alternative assumptions for recruitment and natural mortality in the models we fit to evaluate alternative hypotheses of bottom temperature effects on BSB.

## Basic structure {-}

The first year modeled for the population is 1989 and the fishery and index data used in the model span from 1989 to 2021. The north and south stock components are modeled as separate populations that spawn and recruit in respective regions and there are eight age classes with the last being a plus group ($a \in \{1,\ldots,8+\}$). We have observations for each of four total fishing fleets, where two fishing fleets (recreational and commercial) operate in each region.

There are 11 "seasonal" intervals within each calendar year: five monthly time intervals from Jan 1 to May 31, a spawning season from June 1 to July 31, and five monthly intervals from August 1 to December 31. The southern stock component is assumed to never move to the northern region. For the northern component, a proportion $\mu_{\text{N}\rightarrow \text{S}}$ can move to the southern region each month during the last five months of the year, but no movement is allowed from the south to the north during this period (Figure \ref{fig:migration-diagram}). During the first four intervals of the year a proportion $\mu_{\text{S}\rightarrow \text{N}}$ of the northern component individuals in the south can move back to the north, but no movement from the north to south is allowed during this period. In the fifth interval (May), all northern component individuals remaining in the south are assumed to move back to the north for the subsequent spawning period. Survival and movement occur sequentially in each interval and each of the two movement proportions are assumed constant across intervals, ages, and years.

The two monthly movement matrices are
\begin{equation*}
\boldsymbol{\mu}_{1} = 
  \begin{bmatrix}
     1-\mu_{\text{N}\rightarrow \text{S}} & \mu_{\text{N}\rightarrow \text{S}} \\
     0 & 1 \\
  \end{bmatrix}
\end{equation*}
for the portion of the year after spawning and
\begin{equation*}
\boldsymbol{\mu}_{2} = 
  \begin{bmatrix}
     1 &  0 \\
     \mu_{\text{S}\rightarrow \text{N}} & 1-\mu_{\text{S}\rightarrow \text{N}} \\
  \end{bmatrix}
\end{equation*}
for the portion of the year before spawning. As noted in the description of the general WHAM model, tagging data are not yet included. However, the Working Group also fit a Stock Synthesis model [@methotwetzel13] which included tagging data and provided estimated movement rate parameters and standard errors that were used to configure the priors for WHAM (see Supplementary Materials).

With movement as configured, the northern origin fish (ages 2+) can occur in the southern region on January 1. Estimating initial numbers at age as separate parameters can be challenging even in single-stock models, but for BSB the available data cannot distinguish the proportion of northern and southern component fish at each age in the southern region in the initial year of the model. Therefore, we used the simplifying equilibrium assumption where there are two parameters estimated for each stock component (Eq. \ref{eq:npraa}).

For subsequent years, all models have AR1 correlation of recruitment and 2DAR1 correlation for apparent survival random effects for both the northern and southern stock components. Models with apparent survival random effects will model the transitions (conditional on both survival and movement) of abundances at age of northern origin fish in each region, but there appears to be little information in the existing data from the southern region to distinguish apparent survival random effects for each stock component. All models we considered assume a very small variance for the transitions of northern fish in the southern region, which is essentially the same as the deterministic transition assumptions of a statistical catch at age model.  Unique variance and correlation parameters for the recruitment and apparent survival random effects are estimated for the northern and southern components.

## Bottom temperature effects {-}

All models include observations of winter bottom temperature anomalies for the northern and southern regions from 1959 to 2021 and standard errors of observations ranged between 0.03 and 0.09 degrees Celsius [@nefsc23]. We provide details about the derivation of these observations in the Supplementary Materials. We retained the assumption from the peer-reviewed assessment that treated the latent bottom temperature covariates in each region as AR1 processes. 

We fit 14 models with alternative assumptions about the effects of bottom temperature covariates, ranging from no effects to effects on both regions for either recruitment or natural mortality at age 1 (Table \ref{tab:model-desc-table}). These analyses derive from the hypothesis that bottom temperature affects survival over the first winter where fish turn from age 0 to age 1 on January 1 [@milleretal16_yoy_survival]. This covariate may be a proxy for temperature prior to January 1 and affect survival during the end of the pre-recruit phase or natural mortality in the early part of the year after becoming age 1. Furthermore, we have no direct observations of age 1 individuals from surveys until the spring season each year. Therefore, we fit models with effects of temperature on recruitment or natural mortality at age 1. 


We assume the covariate in year $y$ affects recruitment in the same year because the covariate observations are from winter months. The fish are technically already 1 year old, but there are no observations of these individuals until later in the spring except possibly in fishery catches which are accumulated over the whole year. Expected log-recruitment for a given stock component is a linear function of bottom temperature
\begin{equation}\label{eq:expected-recruitment}
E\left(\log N_{y,1,r_s}|X_{y}\right) = \theta_{R} + \beta_{R} X_y.
\end{equation}
and the annual recruitment is
\begin{equation}\label{eq:Rec-re}
\log N_{y,1,r_s} = E\left(\log N_{y,1,r_s}|X_y\right) + \varepsilon_{y,1,r_s},
\end{equation}
where $\varepsilon_{y,1,r_s}$ are the normally distributed random effects with AR1 correlation structure.

Similarly, expected log-natural morality rate as a function of bottom temperature is
\begin{equation}\label{eq:expected-M1}
E\left(\log M_{y,1,r_s}|X_y\right) = \theta_{M,a,r_s} + \beta_{M} X_y.
\end{equation}
The mean log natural mortality rate is assumed to be $\theta_{M,a,r} = \log(0.4)$ for all ages and regions as recommended by the Working Group. @milleretal18 showed how inferences of temperature effects on growth or maturity parameters can be very different depending on whether the compared models with and without the effect also include random effects representing residual temporal variation in parameters. Therefore, we also explored whether including temporal random effects on age 1 natural mortality affected inferences on corresponding temperature effects. The model for annual natural mortality for a given stock is
\begin{equation}\label{eq:M-re}
\log M_{y,1,r_s} = E\left(\log M_{y,1,r_s}|X_y\right) + \varepsilon_{M,y,1,r_s}.
\end{equation}
Because the bottom temperature anomalies are centered and $E(\varepsilon_{M,y,1,r_s}) = 0$, mean log-natural mortality at age 1 over the time series should be approximately equal to $\theta_{M,a,r_s}$ for models that include those effects. 

Initially, we included random effects on age 1 natural mortality for both the northern and southern stock components, but estimates of these random effects and corresponding variance for the southern component converged to 0 so these were not included in models presented here. Because age 1 fish for the northern component can exist in both regions after January 1, other than during the spawning period, natural mortality is acting in both regions for this stock. For models with covariate and(or) annual random effects for age 1 fish, we use them only in the northern region for the northern component. 


## Uncertainty in recreational index observations {-}

The estimated coefficients of variation (CVs) provided by the analyses by the Working Group to generate the recreational catch per angler (recreational CPA) index ranged between 0.02 and 0.06 which the Working Group felt did not capture the true observation uncertainty in the index with regard to its relationship to stock abundance. All models we considered allowed a scalar multiple of the standard deviation of the log aggregate index to be estimated for these indices in the northern and southern regions. Although lack of model convergence was observed in many fits for self-test simulations, the estimation of critical model output (e.g., SSB, fishing mortality) was reliable and robust to the poor estimation of these scalars (Figure \ref{fig:self-test-fig}), and estimating these parameters rather than fixing them in the fit to the actual data allows uncertainty in model output to be more properly conveyed.

## Index and catch age composition observations {-}

The Working Group investigated many alternative assumptions for the probability models and selectivity forms for the eight different sets of age composition observations to reduce residual and retrospective patterns. These analyses resulted in use of selectivity random effects for the northern fleet and indices, logistic-normal likelihoods for six sets of age composition observations, and Dirichlet-multinomial likelihoods for one index and one fleet in the northern region (Table \ref{tab:age-comp-sel-table}).


## Model fitting and diagnostics {-}

We used a development version ([commit 53e236b](https://github.com/timjmiller/wham/tree/53e236b)) of the WHAM package after the release of version 2.0 for all results. All code for fitting models and generating results can be found at [github.com/timjmiller/multi_wham_bsb](https://github.com/timjmiller/multi_wham_bsb). 

We examined retrospective patterns for all models by fitting corresponding models where the terminal year is reduced sequentially by one year (peel) for seven years. Therefore, there are eight fits of each model with the time series reduced by zero to seven years. We  calculated Mohn's $\rho$ for SSB, and average fishing mortality rate at ages 6 and 7. Absolute values of Mohn's $\rho$ near 0 imply no pattern in estimation of these quantities as the time-series is sequentially extended [@mohn99]. As in @milleretal16, we also assessed the consistency of the AIC-based model selection over retrospective peels to guard against previously noted changes in perception of covariate effects on recruitment with increased length of the time series of observations [@myers98]. This retrospective examination was also recommended by @brooks24.

We performed a jitter analysis of the base model $M_0$ and the best fitting model to investigate whether a local mimimum of the negative log-likelihood surface was obtained by the optimization. We used the \verb|jitter_wham| function in the WHAM package which by default simulates starting values from a multivariate normal distribution with mean and covariance defined by the MLEs and hessian-based covariance matrix from the fitted model (Supplementary Materials).

For the best performing model, we also performed simulation self-tests where new observations were simulated conditional on all estimated fixed and random effects and the same model configuration was fit to each of the simulated data sets. We estimated median relative bias of SSB across these simulations. Finally, we fitted three sensitivity models which differed from the best performing model, by 1) assuming no movement for either stock component, 2) movement parameters are fixed at the means for the prior distributions, and 3) a constant natural mortality rate is estimated across all regions and stocks (Supplementary Materials).

## Reference points and projections {-}

We produced SPR-based reference point estimates ($F_{40\%}$ and SSB$_{40\%}$, setting $p=40$ in eq. \ref{eq:newton-obj}) from the best performing model using a variety of options provided in WHAM. We generated annual reference point estimates based on the annual weight at age, maturity at age, natural mortality, fleet selectivity, and either the annual recruitment random effect (Eq. \ref{eq:Rec-re}) or the annual expected recruitment (Eq. \ref{eq:expected-recruitment}). We also calculated status as the ratios of annual average fishing mortality rates and SSB to the corresponding reference points. Finally, we calculated "prevailing" reference points using the average weight, maturity, natural mortality rate, and fleet selectivity from the last 5 years (2017 to 2021) and average recruitment over years 2000 to 2021, and made Kobe plots of joint status for the terminal year of the model (2021). All reference points and status estimates are generated for each region as well as for the total stock area. 

We projected the best BSB model under three alternative scenarios for the bottom temperature covariate where 1) the AR1 time-series model continues into the projection years, 2) the average of the most recent 5 years is projected, and 3) bottom temperature increases in projection years following a prediction from a simple linear regression of the estimated bottom temperature anomalies over time. We specified fishing mortality in projection years to be constant at the value in the last model year (2021). Average weight, natural mortality, movement, and maturity at age over the last 5 years are used in projection years, whereas the AR1 processes for all numbers at age random effects are continued.

# Results {-}

We found the best model of bottom temperature covariate effects included the effect only on recruitment of the northern stock component and no random effects on age 1 natural mortality ($M_1$, Tables \ref{tab:diff-aic-table} and  \ref{tab:aic-wts-table}). Model $M_1$ consistently had the lowest AIC across retrospective peels where the terminal years of data are removed from the model. The difference in AIC for the model that also included bottom temperature effects on recruitment for the southern component ($M_3$) suggested some evidence for this hypothesis as well. There was little evidence for also including random effects on age 1 natural mortality for the northern stock component. However, when more than three terminal years of data were removed, the evidence for adding age 1 natural mortality random effects for the northern component ($M_8$) increased similar to adding bottom temperature effects on southern component recruitment ($M_3$).

Comparisons of estimates from retrospective peels did not show any indication of differences in model performance. There was little variation in measures of retrospective patterns for SSB or fishing mortality across models. Mohn's $\rho \approx -0.03$ for SSB of both stock components and Mohn's $\rho \approx 0.03$ and $\approx -0.04$ for average $F$ at ages 6 and 7 in north and south regions, respectively (Table \ref{tab:rho-table}). 

Estimated positive effects of bottom temperature on recruitment for the northern or southern components were stable over the retrospective peels and differed negligibly whether effects for each component were estimated in isolation or together (Table \ref{tab:beta-sig-peel-table}). The estimates for the effects on each stock component were essentially equivalent whether the effect was on one component or both. Estimates of residual variability in northern component recruitment, as measured by the conditional or marginal standard deviation of the recruitment random effects, increased slightly with the number of peeled years. However, the ratio of standard deviations of models with and without temperature effects was stable with approximately 20% reduction in residual standard deviation when temperature effects were included. The residual variation is reduced because the expected recruitment (Eq. \ref{eq:expected-recruitment}) is a function of the covariate (Figure \ref{fig:BT-Ecov-R}). 

The posterior estimates of the bottom temperature covariate match the observations well because of the high precision of the observed anomalies (Figure \ref{fig:bottom-temperature}). The anomalies for the north and south regions appear highly correlated presumably because of the proximity of the two regions. Because the temperature anomalies are treated as latent variables, other data components in the model can affect the estimated anomalies when effects on recruitment are included [e.g., @milleretal18], but in this case the estimates of anomalies are altered negligibly during the population model years when the effect on recruitment is estimated (Figure \ref{fig:Ecov-M1-rel-M0}).

The effect of the anomalies on expected recruitment can be better observed by comparing the time series of the northern and southern components (Figure \ref{fig:E-R-SSB-F}). The expected recruitment for the southern component without any covariate effects is constant over time, whereas the effect of the anomalies on expected recruitment for the northern component induces annual variation in expected recruitment. The annual variation in expected recruitment (and the temperature anomalies) is correlated with the recruitment random effects of the northern component and therefore reduces the residual variation in the recruitment random effects. For the northern stock component, most of the lowest estimated recruitment random effects occurred prior to 2000 and several large recruitment estimates occurred after 2010. For the southern stock component, recruitment random effect estimates have been less variable and similar to the estimated median particularly since 2005. The estimated size of the northern stock component, as measured by SSB, increased substantially since 2005, whereas that for the southern component peaked in 2002. The increase in the northern component is also reflected in the total size of the combined components. Estimated average total fishing mortality rates  across ages 6 and 7 (combining the commercial and recreational fleets) were highest in the southern region prior to 1998 and have declined substantially since then. Estimated fishing mortality rates in the northern region have been less variable, but had largest peaks in 1996, 1999, and 2005. The decline in estimates in the southern component is also reflected in the decline in total fishing mortality across regions.

The estimated movement from the north to the south for the northern stock component is much less than anticipated from the prior distribution that was parameterized based on the companion Stock Synthesis model fit completed by the Working Group (Figure \ref{fig:move-prior-posterior}). Conversely, the estimated movement rate from south to north was more consistent and slightly greater than that from the companion model. The estimated movement rates varied little across all fitted models implying that the estimation of movement was not sensitive to the alternative assumptions we considered. Furthermore, the very low estimated movement rate from north to south is also consistent with preliminary fits of the WHAM model without the prior distribution where the movement rate was estimated at the lower bound of 0 resulting in a lack of convergence. The estimated movement rates imply that a very small fraction of northern fish are ever in the southern region.

The 2DAR1 random effects for the selectivity parameters of the northern recreational fleet indicate a decrease in selectivity at ages 2 to 6 over the time series which corresponds to increases in the size limits in regulations by states where these catches occurred (Figure \ref{fig:selectivity-re}). The model also estimated a more modest decrease in selectivity at ages 2 to 3 for the northern commercial fleet. The selectivity at the youngest ages for the two fishery independent indices varied over time but without notable trend. The selectivity of fleets and indices in the south increased with age, but were constant over time (Figure \ref{fig:selectivity-south}).

The three sensitivity fits suggest the estimates of stock size and fishing mortality are fairly robust to whether the movement rates are fixed at the values from the companion Stock Synthesis fit or whether no movement is assumed (Figure \ref{fig:sensitivity-plots}). A constant natural mortality rate was estimable, but the estimated rate (0.72) is nearly twice that determined by the Working Group and resulted in generally higher stock sizes and lower fishing mortality rates.

## Reference points {-}

Using the expected recruitment rather than the random effects as the multiplier with $\upphi(\widetilde{F})$ (eq. \ref{eq:ssbpr}) results in less variable estimates of annual SSB$_{40\%}$ (Figure \ref{fig:annual-BRPs}: top row). Estimates were less variable for the southern stock component than the northern stock component mainly because the expected recruitment is constant for the former, whereas that for the northern component varies via the effect of the bottom temperature anomalies. Temporal variation for the southern stock component is mainly caused by annual variation in the inputs to the $\upphi(\widetilde{F})$ calculation and $F_{40\%}$, but there is also some effect of the variation in the proportion of total recruitment for each stock component as used in the weighting terms to define the 40\% reduction in $\upphi(0)$ ($\lambda_s$ in Eq. \ref{eq:newton-obj}). Using the recruitment random effects instead of expected recruitment creates more uncertain estimates of SSB$_{40\%}$ for the southern stock component, whereas there is little difference for the northern component because there is less difference in the types of recruitment estimates resulting from the covariate effects (Figure \ref{fig:annual-SSB40-cvs}).

Ratios of SSB to SSB$_{40\%}$ should be viewed with caution because the SSB reference point is being defined using annual recruitments rather than some form of average recruitment and therefore, ratios larger than 2.5 which would correspond to unfished population sizes are possible (Figure \ref{fig:annual-BRPs}: second row). However, for the southern component, using the constant expected recruitment is comparable to using median recruitment and the annual variation in the inputs to $\upphi(\widetilde{F})$ indicates no years where SSB was greater than unfished levels throughout the time series. The patterns in uncertainty of SSB ratios are the same as those for the SSB reference points (Figure \ref{fig:annual-SSB-status-cvs}).

Differences between annual $F_{40\%}$ estimates using the alternative types of recruitment estimates are much less than those for SSB$_{40\%}$ because the recruitment estimates are only used in the weighting of the stock component-specific $\upphi(\widetilde{F})$ to determine $F_{40\%}$ ($\lambda_s$ in Eq. \ref{eq:newton-obj}, Figure \ref{fig:annual-BRPs}: third row). For similar reasons, estimates of uncertainty of $F_{40\%}$ are also similar between the type of recruitment estimates (Figure \ref{fig:annual-F40-cvs}). Annual estimates for the northern stock component were lowest in the earliest years of the time series, whereas those for the southern component are relatively stable over time.

For a given type of recruitment used to calculate $F_{40\%}$, the annual ratios of average $F$ to the corresponding reference point are identical for each stock component and in total because of the selectivity used to define a single F reference point across both regions is exactly the same as that for the annual estimate of fishing mortality at age by fleet (Figure \ref{fig:annual-BRPs}: fourth row). As for annual $F_{40\%}$, estimates of uncertainty in the ratios are similar whether expected recruitment or the random effects are used to calculate the reference points (Figure \ref{fig:annual-F-status-cvs}).

Unlike the annual ratios of $F$ to $F_{40\%}$, the $F_{40\%}$ under prevailing conditions uses a selectivity defined by the average $F$ at age and fleet over the last 5 years, which is different from that of the selectivity in the terminal year and therefore those ratios for each region and in total are different (Figure \ref{fig:annual-BRPs}: bottom row). Although the alternative types of recruitment estimates result in different points on the Kobe plots for joint status, the uncertainty in the estimates suggest similar probabilities of alternative quadrants. However, the usage of the confidence regions of the ratios to define probabilities is an approximation because these ratios are functions of both empirical Bayes estimates of random effects as well as maximum likelihood estimates of fixed effects. 


## Projections {-}

When continuing the AR1 model for the bottom temperature anomalies in the projection years, the uncertainty grows and asymptotes to a level determined by the marginal variance of the process and the predicted value approaches the estimated marginal mean value of approximately 0 (Figure \ref{fig:R-BT-proj}). There is no uncertainty in the projected linear trend because the values were specified as known, whereas there is a small level of uncertainty in the projections of the recent average based on the uncertainty in the estimated mean. Comparing projected recruitment for the northern and southern stock components, the projected expected recruitment has much lower uncertainty than the projected random effects regardless of whether bottom temperature affects recruitment. For the northern component, CVs of projected expected recruitments are smaller than those of recruitment random effects, but there are larger differences between CVs of projected expected recruitment assuming AR1 and the other scenarios for future bottom temperature anomalies (Figure \ref{fig:R-F-SSB-CVs}).

Because projected fishing mortality is specified to be the same as that in the terminal year the same uncertainty is also propagated in the projections (Figure \ref{fig:F-SSB-proj}). As we would expect, there is no effect of alternative assumptions about bottom temperature in the projections for the southern stock component because the effect of the bottom temperature anomaly is only on the northern component. However, the alternative bottom temperature assumptions do affect projections of northern component SSB and the projections do not stabilize when the anomalies are projected to increase linearly. When the same AR1 assumption for the bottom temperature anomalies is used in projections, CVs of northern and total SSB projections are larger than when the recent average or linear trend are assumed (Figure \ref{fig:R-F-SSB-CVs}).

Unlike the annual reference points during the model years (prior to 2022), components of the $\upphi(\widetilde{F})$ calculations are constant in the projection years where the only changing annual values are the recruitments used in the weighting for $F_{40\%}$ and the recruitments used to calculate the resulting SSB$_{40\%}$ (Figure \ref{fig:brps-proj}). Estimated reference points in the first few projection years can differ depending on whether the expected recruitment or the random effects are used in their calculation, but longer term projected values are identical because the random effect estimates approach the expected values as the influence of observations diminishes. However, the estimates of uncertainty in the longer term reference points is lower using the expected recruitment rather than the random effects (Figures \ref{fig:annual-SSB40-cvs} and \ref{fig:annual-F40-cvs}). The reduction in uncertainty using expected recruitment is less for $F_{40\%}$ than SSB$_{40\%}$ and for the northern component which includes bottom temperature effects than the southern component.

# Discussion {-}

## Black sea bass {-}

In our investigation of bottom temperature effects on recruitment and natural mortality, and time-varying random effects on natural mortality at age 1, we found only including effects on recruitment for the northern stock component to be the best model with respect to AIC.  BSB in the NEUS is at the northern extent of its range and the estimated increase in expected recruitment with temperature for the northern stock component is consistent with its range extension to the north [@mcmahanetal20].  Opposite effects of temperature on recruitment or population size would be expected for species in the same general area that are at the southern extent of their range [@gabriel92]. For example, higher recruitment of the Southern New England-Mid-Atlantic stock of yellowtail flounder is correlated with more cold water persistence into summer and fall on the Northeast US shelf [@sullivanetal05;@milleretal16].

Our finding regarding bottom temperature effects is consistent with the bottom temperature effects on recruitment in the assessment model accepted during the peer-review process and which is currently used to assess the stock [@nefsc23].  However, AIC suggested some weight for models with temperature effects on recruitment for the southern component and random effects on M at age 1. Although this might suggest making inferences on the population by using an ensemble of these and weighting by AIC [@burnhamanderson02], the estimates of assessment outputs relevant for management (e.g., SSB and $F$) were similar among the models and weighted estimates would differ very little from the estimates with the lowest AIC. Continued monitoring of temperature effects on the southern component and investigations of non-linear effects of temperature for both components may be prudent because of the possibility of an optimal temperature range for survival via effects on growth during the pre-recruit phase [@warelambert85;@anderson88]. Furthermore, our inferences about effects on natural mortality at age 1 may be influenced by our assumptions of constant median (or just constant, depending on the model) natural mortality rate and movement rates for all ages. Further investigations of variation in these parameters with age and effects of bottom temperature could improve our understanding of the demography for this stock.

We showed that using expected recruitment rather than recruitment random effects to define reference points can produce the same estimates but with lower uncertainty. Although the option is unavailable currently in WHAM, we expect using expected bottom temperature anomalies rather than the random effects would also result in the same reference points and even lower uncertainty. These results can be important for management when uncertainty in assessment output is used in making catch advice. The typical approach for defining stock and harvest status is to compare reference points defined under prevailing conditions with current stock and harvest levels, but, as we demonstrated, it is also possible to make the comparisons of projected stock and harvest levels with projected reference points. The uncertainty in these ratios could also be used in defining catch advice. 

Reference points under prevailing conditions use average values for recruitment and other inputs and MSY-based reference points are based on the stock-recruit relationship which is also typically constant over time. If reference points should be defined in such a way that they are less variable than the stock over time, expected inputs to the reference points (instead of annual values) would be more appropriate. Lower variability in reference points would presumably correlate with lower variability in catch advice which might be desirable [e.g., @cochraneetal98;@kelletal05], but the appropriate level of temporal variability in reference points and catch advice will depend on the characteristics of the fish stock, associated fisheries, and management structure [@holland10;@puntetal16]. 

For BSB, it is evident that the projection methodology of the environmental covariate has an impact on short-term projection estimates of recruitment and SSB (Figures \ref{fig:R-BT-proj} and \ref{fig:F-SSB-proj}). In the projection period, the AR1 models for bottom temperature and recuitment revert to the long-term means of those processes. This is most likely not an appropriate assumption for stocks in the NEUS given observations and hypotheses of increasing water temperature and changing environmental conditions [@hareetal16;@pershingetal21]. Because of these concerns, the most recent stock assessment for yellowtail flounder [@nefsc24a] used a change point analysis on environmental covariates to determine current conditions. The mean environmental covariate from the current condition was then used as a data input in WHAM to inform short-term projections. Unfortunately, this methodology still has limitations because it is unlikely that current environmental conditions are stable. Similarly, a linear increase of temperature is also not likely in the future (top row of Figure \ref{fig:E-R-SSB-F}). As more assessments begin including effects of environmental covariates explicitly in assessment models, assumptions about these covariates in reference points and population projections becomes an important decision in the management process. 


## General model {-}

WHAM provides a large class of models for time- and age-varying random effects for population attributes and treatment of environmental covariates and their effects on populations using state-space methods. This framework accounts for the magnitude of differing uncertainties in observations and stochastic population dynamics processes. Version 2.0 extends these inferences to movement rates for multi-region models and stock(component)-specific configuration of random and environmental covariate effects.

An obvious limitation to WHAM is the inability to include tagging observations of any type. Such observations are critical to estimation of movement parameters [e.g., @goetheletal19]. We used estimates of movement parameters from a companion assessment model to define prior distributions for corresponding movement parameters in the state-space BSB model, but other than the tagging data, both of the assessment models used much the same data which can lead to inappropriate inferences. In lieu of integrating an observation model for the tagging data, a better approach would be to estimate the movement parameters externally from just the tagging data.

Tagging data can also inform mortality rate parameters [@hampton91]. It is well known that natural mortality rates are seldom estimated in assessment models because the observed data often provide little information to distinguish natural mortality rates from other assessment model parameters [@leeetal11;@clark22]. Estimation of natural mortality may be even more challenging within state-space assessment models with their greater flexibility from inclusion of time-varying random effects. For example, we fixed the mean natural mortality for age 1 fish and both @cadigan16 and @stocketal21 also estimated natural mortality deviations. However, the simulation studies of @milleretalinreview1 suggest estimating natural mortality in WHAM is feasible in some situations with typical assessment data. Regardless, tagging observations can provide improved inferences and allowing tagging observations in WHAM should be a high priority even for models with a single stock and region.

WHAM version 2.0 only allows models where each stock spawns and recruits in a single region; however, some stocks are assessed with spatial units that are assumed to have a global stock and recruitment model that distributes recruitment to each region [@kapuretal21]. Therefore, extending WHAM to allow such models would be beneficial. Finally, because age composition data are scarce for many stocks, incorporating the work by @correaetal23 on allowing length composition and modeling growth within WHAM would provide an assessment tool to include process errors in assessment with such data and possibly with multiple stocks and regions.

Our application to BSB is a particular combination of the spatial modeling options described by @bergeretal24. Other combinations of the described options are possible in WHAM 2.0. For example, WHAM 2.0 can accommodate all of fleet structure options described in Table 2 by @bergeretal24 and we expect more of these options to become available in future versions of WHAM.

# Acknowledgements {-}

We express our gratitude to the many scientists who have collected and processed the data that went into the assessment model, including survey biologists, port samplers, observers and agers. We thank the BSB research track assessment working group and peer-reviewers for the work compiling data and determining many of the configurations of the BSB assessment model that we used for our analyses. We also thank Chris Legault, two anonymous reviewers, and the associate editor for comments and suggestions that improved the clarity of this paper.

# Competing Interests {-}

The authors declare there are no competing interests.

# Data and Code Availability {-}

As described in the methods section, all data and code for conducting analyses and creating the manuscript are available at [DOI].

\pagebreak

# References {-}

<div id="refs"></div>

\pagebreak



\pagebreak

# Figures {-}


(ref:caption) The Northwest Atlantic coastal area where the Northeast US black sea bass stock occurs. The red line indicates the Hudson Canyon delineation of northern and southern regions and spawning populations [after @milleretal16_yoy_survival] and the bathymetric contour is the 400 m isocline. Map created with datum NAD83 and Latitude-Longitude coordinate system. 

```{r map, echo = FALSE, out.width="100%", fig.align="center", fig.cap = "(ref:caption)"}
knitr::include_graphics(here::here("paper","map.pdf"))
```
\pagebreak

```{r migration-diagram, echo = FALSE, out.width="80%", fig.align="center", fig.cap = "Diagram of intervals within the year and configuation of the dynamics of each component of the black sea bass population."}
knitr::include_graphics(here::here("paper","bsb_movement_diagram.pdf"))
```
\pagebreak

```{r E-R-SSB-F, echo = FALSE, eval= TRUE, out.height = "95%", fit.align = "center", fig.cap = "Annual observations and posterior estimates of bottom temperature anomalies (top row), annual expected and random effect recruitment estimates (second row) and SSB and average fishing mortality at ages 6 and 7 from model $M_1$. Columns define estimates regionally (spawning region for SSB) and total SSB and fishing mortality across regions. Polygons and vertical lines represent 95\\% confidence intervals."}
knitr::include_graphics(here::here("paper", "E_R_SSB_F_fig.pdf"))
```
\pagebreak

```{r move-prior-posterior, echo = FALSE, eval= TRUE, out.width = "100%", fit.align = "center", fig.cap = "Prior (black) and posterior (red) distributions of the movement parameter for the northern stock component from north to south (top) and south to north (bottom). Vertical lines indicate the prior and posterior estimates."}
knitr::include_graphics(here::here("paper", "move_prior_post.pdf"))
```
\pagebreak



```{r selectivity-re, echo = FALSE, eval= TRUE, out.height = "95%", fit.align = "center", fig.cap = "Time and age-varying selectivty for fleets and indices in the northern region with autoregressive random effects."}
knitr::include_graphics(here::here("paper", "selectivity_re_plot.pdf"))
```
\pagebreak

```{r annual-BRPs, echo = FALSE, eval= TRUE, out.height = "85%", fit.align = "center", fig.cap = "Estimates of average equilibrium $F$ at ages 6 and 7 that produces the 40\\% spawning potential ratio ($F_{40\\%}$), equilibrium SSB at $F_{40\\%}$ based on annual inputs to $\\upphi(\\widetilde{F})$ calculations, annual fishing and biomass status (ratios), and bivariate kobe plots of status in 2021 where reference points represent prevailing conditions with inputs to $\\upphi(\\widetilde{F})$ averaged over the last 5 years and recruitment is averaged over the time series. Red and blue in first 4 rows and black and gray in final row indicate alternative annual estimates of recruitment (random effect or expected). All results are based on model $M_1$. Polygons represent 95\\% confidence intervals or regions."}
knitr::include_graphics(here::here("paper", "brp_status_results.pdf"))
```


```{r R-BT-proj, echo = FALSE, eval= TRUE, out.height = "95%", fit.align = "center", fig.cap = "Annual estimates of bottom temperature in the northern region and alternative recruitment estimates (random effect or expected) by region. Estimates from years after 2021 are from projections of model $M_1$ under three alternative assumptions for the bottom temperature anomalies in the northern region. Vertical dotted lines indicate the last year of data and polygons represent 95\\% confidence intervals."}
knitr::include_graphics(here::here("paper", "proj_ecov_Recruit_results.pdf"))
```

```{r F-SSB-proj, echo = FALSE, eval= TRUE, out.height = "95%", fit.align = "center", fig.cap = "Annual estimates of average fishing mortality and SSB by region and in total. Estimates in years beyond 2021 are from projecting model $M_1$ under alternative assumptions for bottom temperature anomalies in the northern region. Vertical dotted lines indicate the last year of data and polygons represent 95\\% confidence intervals."}
knitr::include_graphics(here::here("paper", "proj_F_SSB.pdf"))
```

\begin{landscape}

```{r brps-proj, echo = FALSE, eval= TRUE, out.height = "95%", fit.align = "center", fig.cap = "Annual estimates by region and in total of average equilibrium $F$ at ages 6 and 7 that produces the 40\\% spawning potential ratio and SSB at $F_{40\\%}$. Estimates in years beyond 2021 are from projecting model $M_1$ under alternative assumptions for bottom temperature anomalies in the northern region and average $\\upphi(\\widetilde{F})$ inputs from the last 5 years of the unprojected model. Vertical dotted lines indicate the last year of data and polygons represent 95\\% confidence intervals."}
knitr::include_graphics(here::here("paper", "proj_brps.pdf"))
```

\end{landscape}

\clearpage

\setcounter{table}{0}
\renewcommand\thetable{\arabic{table}}


# Tables {-}



```{r, echo = F, eval = T}
mod_names <- paste0("$M_{", 0:13,"}$")
col_names <- c("Model", "North", "South", "$M$ at age 1 random effects")

mod_table <- matrix(nrow = length(mod_names), ncol = length(col_names), dimnames = list(mod_names,col_names))

mod_table[,1] <- mod_names
mod_table[,2:4] <- "--"
mod_table[,4] <- rep(c("none", "time-varying"), each = 7)
mod_table[c(2,4),2] <- "Recruitment"
mod_table[c(3,4),3] <- "Recruitment"
mod_table[c(5,7),2] <- "$M$ at age 1"
mod_table[c(6,7),3] <- "$M$ at age 1"
mod_table[8:14,2:3] <- mod_table[1:7,2:3]

mod_table %>% kable(format = type, booktabs = T, escape=F, row.names = F, label = "model-desc-table",
    caption="Assumptions for temperature effects and random effects for age 1 natural mortality rates ($M$) for each model.", align = c(rep("l",4))) %>%
  add_header_above(c(" " = 1, "Temperature Effect" = 2, " " = 1 )) %>% kable_styling(latex_options = "hold_position")
```

```{r, echo = F, eval = T}
diff_aic <- readRDS(here::here("results","diff_aic.RDS"))
diff_aic <- data.frame(round(diff_aic, 2))
diff_aic <- cbind(Model = row.names(diff_aic), diff_aic)
row.names(diff_aic) <- NULL
colnames(diff_aic) <- c("Model", as.character(0:7))
diff_aic %>%
  kable(format = type, booktabs = T, escape=F, row.names = FALSE, label = "diff-aic-table",
  caption = "Difference between AIC and the lowest AIC for each model by retrospective peel.") %>%
  add_header_above(c(" " = 1, "Peel" = 8))
```

```{r, echo = F, eval = T}
rho_table <- readRDS("../results/rho_table.RDS")
row.names(rho_table) <- NULL
colnames(rho_table) <- c("Model", rep(c("North","South"), 2))
rho_table %>%
  kable(format = type, booktabs = T, escape=F, row.names = FALSE, label = "rho-table",
  caption = "Mohn's $\\rho$ for SSB, and average F at ages 6 and 7 in northern and southern regions.") %>%
  add_header_above(c(" " = 1, "SSB" = 2, "Average F" = 2))
```
```{r, echo = F, eval = T}
par_names <- paste0("$M_{", c(1,2,3,3),"}$ ", "$\\widehat{\\beta}_{R,", c("N","S"), "}$")
par_names <- c(par_names, paste0("$M_{", rep(0:1, 3),"}$ ", rep(c("Conditional ", "", "Marginal "),each = 2), "$\\widehat{\\", rep(c("sigma","rho","sigma"), each = 2),"}_{R,N}$"))
peel_par_table <- t(readRDS(here::here("results/beta_sigma_par_peel_table.RDS"))[,1:10])
# peel_par_table <- readRDS("../results/beta_sigma_par_peel_table.RDS")[,1:10]
#colnames(peel_par_table) <- par_names
peel_par_table <- cbind.data.frame(par_names, round(peel_par_table,3))
colnames(peel_par_table) <- c("Parameter", as.character(0:7))
row.names(peel_par_table) <- NULL
peel_par_table %>%
  kable(format = type, booktabs = T, escape=F, row.names = FALSE, label = "beta-sig-peel-table",
  caption = "Estimates of temperature effects on recruitment and variance and autocorrelation parameters for recruitment for northern ($N$) and southern ($S$) components for models with no effects ($M_0$), effects on specific components ($M_1$ and $M_2$) or both components simultaneously ($M_3$) from the full model (Peel 0) and each retrospective peel.")%>%
  add_header_above(c(" " = 1, "Peel" = 8))

```

\clearpage

# Appendix A {-}

\setcounter{table}{0}
\renewcommand\thetable{A\arabic{table}}
\input{symboltable_R2.tex}

# Appendix B {-}

New features of WHAM 2.0 that are not used in the application to BSB are described here..

## Simultaneous movement and mortality {-}

When survival and movement are assumed to occur simultaneously, all movement and mortality parameters are instantaneous rates. We obtain the PTM over an interval $i$ by exponentiating the instantaneous rate matrix [@millerandersen08]
\begin{equation*}
\mathbf{P}_{y,a,i} = e^{\mathbf{A}_{y,a,i}\delta_i}
\end{equation*}
The instantaneous rate matrix takes rates of movement between regions and the mortality rates for each fleet and region. Along the diagonal is the negative of the sum of the other rates (the hazard) so each row sums to zero. For two regions and one fleet operating in each region:
 \begin{equation*}
 \mathbf{A}_{y,a,i} = \begin{bmatrix}
 a_{y,a,i,1} & \mu_{1\rightarrow 2,y,a,i} & F_{1,y,a,i} & 0 & M_{y,a,1} \\
 \mu_{2\rightarrow 1,y,a,i} &  a_{y,a,i,2} & 0 & F_{2,y,a,i} & M_{y,a,2} \\
 0 & 0 & 0 & 0 & 0 \\
 0 & 0 & 0 & 0 & 0 \\
 0 & 0 & 0 & 0 & 0
 \end{bmatrix},
\end{equation*}
where $a_{y,a,i,r} = -(\mu_{r\rightarrow r',y,a,i} + M_{y,a,r} + \sum^{n_F}_{f:r_f=r}F_{f,y,a,i})$. When there is one region, $n_F$ fleets, and $\delta_i = 1$, exponentiating the instantaneous rate matrix results in the PTM defined in Eq. \ref{eq:ptm_1_region}.

## Initial abundance at age as random effects {-}

The initial abundances at age can also be treated as independent or AR1 random effects. Defining the vector of initial abundance at age in region $r$ as $\mathbf{N}_{O,1,r}$, the general model is 
\begin{equation*}
\log \mathbf{N}_{O,1,r} = \theta_{N_1,r} + \boldsymbol{\varepsilon}_{N_1,r},
\end{equation*}
where 
\begin{equation*}
Cov\left(\varepsilon_{N_1,a,r},\varepsilon_{N_1,a',r}\right) = \frac{\rho_{N_1,r}^{|a-a'|}\sigma^2_{N_1,r}} {\left(1-\rho_{N_1,r}^2\right)}.
\end{equation*}

## General natural mortality model {-}

The general model for natural mortality at age $a$ for a given stock in region $r$ is a function of random and covariate effects
\begin{equation}\label{eq:M_model}
  \log M_{y,a,r} = \theta_{M,a,r} + \varepsilon_{M,y,a,r} + \sum^{n_E}_{k=1} \beta_{M,r,a,k} X_{k,y} = E\left(\log M_{y,a,r}|X_{k,y}\right) + \varepsilon_{M,y,a,r}.
\end{equation}
The general covariance structure for random effects are modeled most generally as 2DAR1 random effect with age and(or) year where the covariance is
\begin{equation*}
  Cov\left(\varepsilon_{M,y,a,r},\varepsilon_{M,y',a',r}\right) =   \frac{\rho_{M,\text{age},r}^{|a-a'|}\rho_{M,\text{year},r}^{|y-y'|}\sigma^2_{M,r}}{\left(1 -  \rho_{M,\text{age},r}^2\right)\left(1 - \rho_{M,\text{year},r}^2\right)}.
\end{equation*}

## General catchability model {-}

Catchability of each index can be treated as logit functions of normal random effects and(or) environmental covariate effects
\begin{equation*}
\log \left(\frac{q_{m,y}-l_m}{u_m-q_{m,y}}\right) = \theta_{q,m} + \varepsilon_{q,m,y}  + \sum^{n_E}_{k=1} \beta_{q,m,k} X_{k,y},
\end{equation*}
where $\theta_{q,m}$ is an intercept or mean parameter, and $u_{m}$ and $l_{m}$ are the upper and lower bounds of catchability for index $m$ (defaults are 0 and 1000). The general covariance structure for the annual random effects is AR1
\begin{equation*}
Cov\left(\varepsilon_{q,m,y},\varepsilon_{q,m,y'}\right) =   \frac{\rho_{q,m}^{|y-y'|}\sigma^2_{q,m}}{1 - \rho_{q,m}^2}.
\end{equation*}

<!-- \pagebreak -->

<!-- # Supplementary Materials {-} -->

<!-- ## Deriving the prior distribution for movement parameters {-} -->

<!-- The Working Group fit a Stock Synthesis model [@methotwetzel13] that included tagging data with 2 seasons (6 months each) and 2 regions where a proportion $\mu^*_1$ of the northern component moves to the south in one season and some proportion  $\mu^*_{2\rightarrow 1}$ move back to the south in the second season [@nefsc23]. The seasonal movement matrices for each season are -->
<!-- \begin{equation*} -->
<!-- \boldsymbol{\mu}^*_{1} =  -->
<!--   \begin{bmatrix} -->
<!--      1-\mu^*_{1\rightarrow 2} & \mu^*_{1\rightarrow 2} \\ -->
<!--      0 & 1 \\ -->
<!--   \end{bmatrix} -->
<!-- \end{equation*} -->
<!-- and -->
<!-- \begin{equation*} -->
<!-- \boldsymbol{\mu}_{2} =  -->
<!--   \begin{bmatrix} -->
<!--      1 &  0 \\ -->
<!--      \mu^*_{2\rightarrow 1} & 1-\mu^*_{2\rightarrow 1} \\ -->
<!--   \end{bmatrix}. -->
<!-- \end{equation*} -->

<!-- To obtain estimates of movement proportions for the monthly intervals in the WHAM model, the half-year movement matrices were converted to monthly movement matrices by taking the root $z_k$ of $\boldsymbol{\mu}^*_{k}$ which are defined by the number of months of movement for each season (5 and 4, respectively). The roots of the matrices are calculated using an eigen decomposition of the matrices -->
<!-- $$ \boldsymbol{\mu}_k =  \left(\boldsymbol{\mu}_k^*\right)^{z_k} = \mathbf{V}_k \mathbf{D}_k^{z_k} \mathbf{V}_k^{-1},$$ -->
<!-- where $z_1 = 1/5$ for and $z_2 = 1/4$, and $\mathbf{V}_{k}$ and $\mathbf{D}_{k}$ are the matrix of eigenvectors (columnwise) and the diagonal matrix of corresponding eigenvalues of $\boldsymbol{\mu}^*_k$. The Working Group used a parametric bootstrap approach to determine an appropriate standard deviation for the prior distribution for the movement parameters. Stock Synthesis also estimates parameters on a transformed scale, but different from WHAM:  -->
<!-- $$\mu^*_{r\rightarrow r'} = \frac{1}{1 + 2e^{-x_{r\rightarrow r'}}}$$ -->
<!-- The estimated parameters and standard errors from the Stock Synthesis model were $x_{1\rightarrow 2}=-1.44$ and $x_{2\rightarrow 1}=1.94$ and $SE(x_{1\rightarrow 2})) = 0.21$ and $SE(x_{2\rightarrow 1})) = 0.37$. The resulting in the estimated proportions were $\mu^*_{1\rightarrow 2}=0.11$ and $\mu^*_{2\rightarrow 1}=0.78$. -->

<!-- In WHAM, an additive logit transformation is used which is simply a logit transformation when there are only two regions:  -->
<!-- $$ -->
<!-- \mu_{r\rightarrow r'} = \frac{1}{1+e^{-y_{r\rightarrow r'}}}. -->
<!-- $$ -->
<!-- We simulated 1000 values from a normal distribution with mean and standard deviation defined by the parameter estimate and standard error $\tilde x_{{r\rightarrow r'},b} \sim N(x_{r\rightarrow r'}, SE(x_{r\rightarrow r'}))$ from the Stock Synthesis model. For each simulated value we constructed $\tilde {\boldsymbol{\mu}}^*_{{r\rightarrow r'},b}$, took the appropriate root and calculated inverse logit for $\tilde y_{{r\rightarrow r'},b}$. We calculated the mean and standard deviation of the values $y_{i,b}$. The mean values did not differ meaningfully from the transformation of the original estimates ($y_{1\rightarrow 2} = -3.79$ and $y_{2\rightarrow 1} = -0.79$) and the standard deviation was approximately 0.2 for both parameters. -->

<!-- ## Bottom temperature anomalies {-} -->

<!-- The Working Group created bottom temperature observations from a high resolution ocean bottom temperature product by @dupontaviceetal23. The annual observations for each region are defined by the average over all spatial bottom temperature values for February and March by region and year. Similarly, the Working Group calculated standard errors from the standard deviation of all values in the region and the total number of values for a given year.  We created regional bottom temperature anomalies by subtracting means for each region across all years.  -->

<!-- ## Diagnostics {-} -->

<!-- ### Jitter fits for model $M_0$ {-} -->

<!-- WHAM by default completes three newton steps after the stats::nlminb minimization function completes to reduce the gradient at the minimized NLL. However, this generally has negligible effects on model estimates and the NLL. To reduce computation time, we did not complete these newton steps when performing jitter fits of the model. Without the Newton steps, the maximum (absolute) gradient sizes are generally less than 0.01 for models that converge satisfactorily. -->

<!-- The 50 jitter fits demonstrated that a local minimum was obtained for the original fit of model $M_0$ (Figure \ref{fig:jitter-M0}). One lower NLL was obtained with unacceptable gradients (No. 25), but a slightly lower NLL was found with a satisfactory gradient for 3 of the jitters (Nos. 9, 13, 29). However, one of the jitter fits (No. 9) did not provide a non-zero estimate of the variance parameter for one of the indices and the other two provided identical results and we refit model $M_0$ and all remaining models using the better parameter estimates as initial values.  -->

<!-- ### Jitter fits for model $M_1$ {-} -->

<!-- The 50 jitter fits gave no evidence of a better minimization of the NLL. Three lower NLLs were obtained, but with unacceptably large gradients (Figure \ref{fig:jitter-M1}). The largest differences in parameter estimates for these three jitters were for numbers at age and selectivity random effects variance and correlation parameters. -->

<!-- ### Self test for model $M_1$ {-} -->

<!-- Initial fits to simulated data from model $M_1$ showed estimation of the observation error standard deviation multiplier for the recreational catch-per angler indices in the north and south regions was unstable. Many of the fits to the simulated data produced implausible estimates at the 0 boundary for these parameters (very negative values on log-scale). However, across all fits including those with poor convergence, estimation of SSB and fishing mortality was reliable (Figure \ref{fig:self-test-fig}). We also fit analogous models with the multiplier parameters fixed at the true values, which did improve convergence, but larger bias was estimated for fishing mortality and SSB for the northern component. -->

<!-- \setcounter{table}{0} -->
<!-- \renewcommand\thetable{S\arabic{table}} -->


<!-- ```{r, echo = F, eval = T} -->
<!-- age_comp_names <- c("North commercial fleet", "North recreational fleet", "South commercial fleet", "South recreational fleet", -->
<!--   "North recreational CPA index", "North VAST index", "South recreational CPA index", "South VAST index") -->
<!-- age_comp_mod <- c("Dirichlet-Multinomial", "Logistic-normal (Independent)", "Logistic-normal (AR1 correlation)","Logistic-normal (AR1 correlation)", "Logistic-normal (Independent)","Dirichlet-Multinomial","Logistic-normal (AR1 correlation)","Logistic-normal (AR1 correlation)") -->
<!-- mean_sel_mod <- c("age-specific (ages > 3 fully selected)", -->
<!--   "age-specific (ages > 6 fully selected)", -->
<!--   "logistic", "logistic", -->
<!--   "age-specific (ages > 1 fully selected)", -->
<!--   "age-specific (ages > 4 fully selected)", -->
<!--   "age-specific (ages > 2 fully selected)", -->
<!--   "age-specific (ages > 1 fully selected)") -->
<!-- sel_re_mod <- c("AR1 correlation by age and year",  -->
<!--   "AR1 correlation by age and year", -->
<!--   "None", -->
<!--   "None", -->
<!--   "AR1 correlation by year", -->
<!--   "AR1 correlation by age and year", -->
<!--   "None", -->
<!--   "None") -->
<!-- out <- cbind.data.frame("Data component" = age_comp_names,  "Age Composition Likelihood" = age_comp_mod,   -->
<!--   "Mean Selectivity model" = mean_sel_mod, "Random effects Model" = sel_re_mod) -->

<!-- out %>% kable(format = type, booktabs = T, escape=F, row.names = F, label = "age-comp-sel-table", -->
<!--     caption="Configuration of age composition likelihoods, mean selectivity models, and selectivity random effects models for each age composition data component. For all logistic-normal likelihoods, any ages observed as zeros are treated as missing.", align = c(rep("l",4))) %>% landscape() -->
<!-- #knitr::knit_print(kableExtra::landscape(out)) -->

<!-- ``` -->

<!-- ```{r, echo = F, eval = T} -->
<!-- aic_wts <- readRDS("../results/aic_wts.RDS") -->
<!-- aic_wts <- data.frame(round(aic_wts, 2)) -->
<!-- aic_wts <- cbind(Model = row.names(aic_wts), aic_wts) -->
<!-- row.names(aic_wts) <- NULL -->
<!-- colnames(aic_wts) <- c("Model", as.character(0:7)) -->
<!-- aic_wts %>% -->
<!--   kable(format = type, booktabs = T, escape=F, row.names = FALSE, label = "aic-wts-table", -->
<!--   caption = "Model AIC weights for each retrospective peel.") %>% -->
<!--   add_header_above(c(" " = 1, "Peel" = 8)) -->
<!-- ``` -->


<!-- \setcounter{figure}{0} -->
<!-- \renewcommand\thefigure{S\arabic{figure}} -->

<!-- \pagebreak -->

<!-- ```{r self-test-fig, echo = FALSE, eval= TRUE, out.width = "100%", fit.align = "center", fig.cap = "Median relative error of SSB (Total and by stock component) and total fully-selected fishing mortality for estimation models fitted to simulated data from model $M_1$ where the observation variance of log-indices are fixed and estimated. Black and Red dashed lines represent the median of the annual medians and the median across all annual relative errors, respectively. Vertical lines represent 95\\% confidence intervals."} -->
<!-- knitr::include_graphics(here::here("paper", "self_test_results.pdf")) -->
<!-- ``` -->


<!-- ```{r BT-Ecov-R, echo = FALSE, eval= TRUE, out.width = "100%", fit.align = "center", fig.cap = "Expected and random effect recruitment estimates for the northern stock component. Color of points defined by the corresponding annual bottom temperature anomaly."} -->
<!-- knitr::include_graphics(here::here("paper", "best_R_Ecov.pdf")) -->
<!-- ``` -->

<!-- \begin{landscape} -->
<!-- ```{r bottom-temperature, echo = FALSE, eval= TRUE, out.width = "100%", fit.align = "center", fig.cap = "Observations with 95\\% confidence intervals (points with vertical lines) and posterior estimates with 95\\% confidence intervals (lines with polygons) of bottom temperature anomalies in the north and south regions from model $M_1$. Gray vertical line defines the first year that the black sea bass stock is modeled."} -->
<!-- knitr::include_graphics(here::here("paper", "BTA_full_fig.pdf")) -->
<!-- ``` -->
<!-- \end{landscape} -->
<!-- \pagebreak -->


<!-- ```{r Ecov-M1-rel-M0, echo = FALSE, eval= TRUE, out.height = "95%", fit.align = "center", fig.cap = "Relative differences in posterior estimates of northern region bottom temperature anomalies ($\\widehat X$) from the null model without effects on recruitment ($M_0$) and with effects on the northern stock component ($M_1$)."} -->
<!-- knitr::include_graphics(here::here("paper", "Ecov_M1_rel_M0.pdf")) -->
<!-- ``` -->

<!-- ```{r selectivity-south, echo = FALSE, eval= TRUE, out.height = "95%", fit.align = "center", fig.cap = "Selectivty for fleets and indices in the southern region."} -->
<!-- knitr::include_graphics(here::here("paper", "selectivity_south_plot.pdf")) -->
<!-- ``` -->


<!-- \begin{landscape} -->

<!-- ```{r sensitivity-plots, echo = FALSE, eval= TRUE, out.height = "95%", fit.align = "center", fig.cap = "Estimates of annual SSB and fishing mortality rates for the best performing model $M_1$ and models that are otherwise the same except where  1) movement rates are fixed at the means for the prior distribution, 2) a constant natural mortality rate is estimated, or 3) there is no movement for either stock component."} -->
<!-- knitr::include_graphics(here::here("paper", "SSB_F_sensitivity_plots.pdf")) -->
<!-- ``` -->
<!-- \end{landscape} -->


<!-- ```{r annual-SSB40-cvs, echo = FALSE, eval= TRUE, out.height = "95%", fit.align = "center", fig.cap = "Coefficients of variation for annual equilibrium SSB$_{40\\%}$ as a function of annual expected recruitment or recruitment random effects and annual inputs to $\\upphi(\\widetilde{F})$ calculations and alternative annual recruitment types. Estimates in years after 2021 are from projecting model $M_1$ under three alternative assumptions for the bottom temperature anomolies. Vertical dotted lines indicate the last year of data."} -->
<!-- knitr::include_graphics(here::here("paper", "proj_SSB40_CV.pdf")) -->
<!-- ``` -->
<!-- ```{r annual-SSB-status-cvs, echo = FALSE, eval= TRUE, out.height = "95%", fit.align = "center", fig.cap = "Coefficients of variation for annual ratios of SSB and equilibrium SSB$_{40\\%}$ where the latter is a function of annual expected recruitment or recruitment random effects and annual inputs to $\\upphi(\\widetilde{F})$ calculations. Estimates in years after 2021 are from projecting model $M_1$ under three alternative assumptions for the bottom temperature anomolies. Vertical dotted lines indicate the last year of data."} -->
<!-- knitr::include_graphics(here::here("paper", "proj_SSB_status_CV.pdf")) -->
<!-- ``` -->


<!-- ```{r annual-F40-cvs, echo = FALSE, eval= TRUE, out.height = "95%", fit.align = "center", fig.cap = "Coefficients of variation for annual equilibrium average $F$ at ages 6 and 7 that produces the 40\\% spawning potential ratio as a function of annual expected recruitment or recruitment random effects and annual inputs to $\\upphi(\\widetilde{F})$ calculations. Estimates in years after 2021 are from projecting model $M_1$ under three alternative assumptions for the bottom temperature anomolies. Vertical dotted lines indicate the last year of data."} -->
<!-- knitr::include_graphics(here::here("paper", "proj_F40_CV.pdf")) -->
<!-- ``` -->

<!-- ```{r annual-F-status-cvs, echo = FALSE, eval= TRUE, out.height = "95%", fit.align = "center", fig.cap = "Coefficients of variation for annual ratios of average fishing mortality and equilibrium $\\bar{F}_{40\\%}$ at ages 6 and 7 where the latter is a function of annual expected recruitment or recruitment random effects and annual inputs to $\\upphi(\\widetilde{F})$ calculations. Estimates in years after 2021 are from projecting model $M_1$ under three alternative assumptions for the bottom temperature anomolies. Vertical dotted lines indicate the last year of data."} -->
<!-- knitr::include_graphics(here::here("paper", "proj_F_status_CV.pdf")) -->
<!-- ``` -->


<!-- \begin{landscape} -->

<!-- ```{r R-F-SSB-CVs, echo = FALSE, eval= TRUE, out.height = "90%", fit.align = "center", fig.cap = "Coefficients of variation for estimates of alternative recruitment estimates (random effects or expected), average fishing mortality at age 6 and 7, and SSB by region and in total from model $M_1$. Values in years after 2021 are from projecting model $M_1$ under three alternative assumptions for the bottom temperature anomolies. Vertical dotted lines indicate the last year of data."} -->
<!-- knitr::include_graphics(here::here("paper", "R_SSB_F_cv_results.pdf")) -->
<!-- ``` -->
<!-- \end{landscape} -->

<!-- \pagebreak -->

<!-- ```{r jitter-M0, echo = FALSE, eval= TRUE, out.width = "100%", fit.align = "center", fig.cap = "Minimized negative log-likelihood for 50 fits where minimization used initial parameter values jittered from those provided by an initial fit for model $M_0$. Black jitters had maximum absolute gradient values < $10^{-2}$ and red jitters had values > 1."} -->
<!-- knitr::include_graphics(here::here("paper", "fit_0_jitter_plt.pdf")) -->
<!-- ``` -->
<!-- \pagebreak -->

<!-- ```{r jitter-M1, echo = FALSE, eval= TRUE, out.width = "100%", fit.align = "center", fig.cap = "Minimized negative log-likelihood for 50 fits where minimization used initial parameter values jittered from those provided by an initial fit for model $M_1$. Fits with black dots had maximum absolute gradient value < 0.01 and fits with red dots had values > 10."} -->
<!-- knitr::include_graphics(here::here("paper", "fit_1_jitter_plt.pdf")) -->
<!-- ``` -->
<!-- \pagebreak -->


<!-- ```{r SSB-F-R-rel-M1, echo = FALSE, eval= TRUE, out.height = "95%", fit.align = "center", fig.cap = "Estimates of SSB, F, and recruitment relative to those of the best performing model, $M_1$."} -->
<!-- knitr::include_graphics(here::here("paper", "SSB_F_R_rel_M1.pdf")) -->
<!-- ``` -->


<!-- ```{r F-status-proj, echo = FALSE, eval= TRUE, out.height = "95%", fit.align = "center", fig.cap = "Annual estimates of ratios of fishing mortality to $F_{40\\%}$ by region and in total. Estimates in years beyond 2021 are from projecting model $M_1$ under alternative assumptions for bottom temperature anomalies in the northern region. Vertical dotted lines indicate the last year of data and polygons represent 95\\% confidence intervals."} -->
<!-- knitr::include_graphics(here::here("paper", "proj_F_status_results.pdf")) -->
<!-- ``` -->
<!-- ```{r SSB-status-proj, echo = FALSE, eval= TRUE, out.height = "95%", fit.align = "center", fig.cap = "Annual estimates of ratios of SSB to SSB$_{40\\%}$ by region and in total. Estimates in years beyond 2021 are from projecting model $M_1$ under alternative assumptions for bottom temperature anomalies in the northern region. Vertical dotted lines indicate the last year of data and polygons represent 95\\% confidence intervals."} -->
<!-- knitr::include_graphics(here::here("paper", "proj_SSB_status_results.pdf")) -->
<!-- ``` -->
